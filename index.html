<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC価格計算ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 2px solid #e9ecef;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .refresh-rate-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .refresh-rate-btn:hover {
            background: #138496;
        }

        .loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .save-settings-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .save-settings-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .calculator-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .calculator-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .calculator-card.cost-calculation {
            background: #fff8f0;
            border: 2px solid #ffdbbb;
        }

        .calculator-card.cost-calculation:hover {
            box-shadow: 0 8px 24px rgba(255, 152, 0, 0.15);
        }

        .section-divider {
            grid-column: 1 / -1;
            margin: 30px 0;
            text-align: center;
        }

        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            display: inline-block;
            font-size: 1.3em;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .section-title.cost-section {
            background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .calculator-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 1.5em;
        }

        .calculator-card.cost-calculation h2 {
            color: #ff6f00;
            border-bottom: 3px solid #ff9800;
        }

        .calc-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .calc-input-group {
            display: flex;
            flex-direction: column;
        }

        .calc-input-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.9em;
        }

        .calc-input-group input,
        .calc-input-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .result-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .result-item label {
            display: block;
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-item .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #212529;
        }

        .result-item.highlight .value {
            color: #667eea;
            font-size: 1.5em;
        }

        .tariff-table-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .tariff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .tariff-table th,
        .tariff-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tariff-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .tariff-table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 1200px) {
            .settings-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .calc-input-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        .hidden {
            display: none;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #856404;
        }

        .formula {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #0d47a1;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .formula strong {
            color: #1565c0;
        }

        .tutorial-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-left: 15px;
        }

        .tutorial-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .modal-content h3 {
            color: #764ba2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .modal-content p {
            line-height: 1.8;
            color: #495057;
            margin-bottom: 15px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #495057;
        }

        .close-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .step {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .step strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EC価格計算ツール</h1>
            <p>仕入れ価格と販売価格を簡単に計算</p>
            <button class="tutorial-btn" onclick="openTutorial()">使い方ガイド</button>
        </div>

        <div class="settings-section">
            <h2 style="margin-bottom: 20px; color: #495057;">共通設定</h2>
            <div class="settings-grid">
                <!-- 1段目：為替、手数料率、広告費率、ペイオニア手数料 -->
                <div class="input-group">
                    <label>
                        為替レート
                        <button class="refresh-rate-btn" onclick="fetchExchangeRate()">最新取得</button>
                    </label>
                    <input type="number" id="exchangeRate" value="153.435" step="0.001">
                </div>
                <div class="input-group">
                    <label>手数料率 (%)</label>
                    <input type="number" id="feeRate" value="18" step="0.1">
                </div>
                <div class="input-group">
                    <label>広告費率 (%)</label>
                    <input type="number" id="adRate" value="10" step="0.1">
                </div>
                <div class="input-group">
                    <label>ペイオニア手数料 (%)</label>
                    <input type="number" id="payoneerRate" value="2" step="0.1">
                </div>
                <div class="input-group">
                    <label>送料</label>
                    <input type="number" id="shippingCost" value="3000" step="100">
                </div>
                <!-- 2段目：関税率、通関手数料、安全係数、DDU閾値、DDU閾値時の関税額 -->
                <div class="input-group">
                    <label>関税率 (%)</label>
                    <input type="number" id="tariffRate" value="15" step="0.1">
                </div>
                <div class="input-group">
                    <label>通関手数料</label>
                    <input type="number" id="customsFee" value="10" step="1">
                </div>
                <div class="input-group">
                    <label>安全係数</label>
                    <input type="number" id="safetyFactor" value="1.35" step="0.01">
                </div>
                <div class="input-group">
                    <label>DDU閾値（ドル）</label>
                    <input type="number" id="dduThreshold" value="1500" step="10">
                </div>
                <div class="input-group">
                    <label>DDU閾値時の関税額（ドル）</label>
                    <input type="number" id="dduThresholdTariff" value="310" step="5">
                </div>
            </div>
            <button class="save-settings-btn" onclick="saveSettings()">設定を保存</button>
        </div>

        <div class="main-content">
            <!-- セクション: 販売価格算出 -->
            <div class="section-divider">
                <div class="section-title">販売価格算出</div>
            </div>

            <!-- 利益額ベース: 仕入れ→販売価格 -->
            <div class="calculator-card">
                <h2>利益額で計算（仕入れ→販売価格）</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>仕入れ価格（円）</label>
                        <input type="number" id="cost1" value="5000" step="1000">
                    </div>
                    <div class="calc-input-group">
                        <label>利益額（円）</label>
                        <input type="number" id="profit1" value="3000" step="100">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculatePriceFromCostProfit()">計算する</button>
                <div id="result1" class="result-section hidden">
                    <h3>計算結果</h3>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>販売価格（ドル）</label>
                            <div class="value" id="sellingPrice1">-</div>
                        </div>
                        <div class="result-item">
                            <label>想定関税</label>
                            <div class="value" id="tariff1">-</div>
                        </div>
                        <div class="result-item">
                            <label>調整額</label>
                            <div class="value" id="adjustment1">-</div>
                        </div>
                        <div class="result-item">
                            <label>実質販売額</label>
                            <div class="value" id="actualPrice1">-</div>
                        </div>
                        <div class="result-item">
                            <label>送料として徴収関税</label>
                            <div class="value" id="shippingTariff1">-</div>
                        </div>
                        <div class="result-item highlight">
                            <label>DDP価格（ドル）</label>
                            <div class="value" id="ddpPrice1">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfit1">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        販売価格 = (仕入れ価格 + 送料 + 利益額) ÷ 為替レート ÷ (1 - 手数料率 - 広告費率 - ペイオニア率)
                    </div>
                </div>
            </div>

            <!-- 利益率ベース: 仕入れ→販売価格 -->
            <div class="calculator-card">
                <h2>利益率で計算（仕入れ→販売価格）</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>仕入れ価格（円）</label>
                        <input type="number" id="cost2" value="5000" step="1000">
                    </div>
                    <div class="calc-input-group">
                        <label>利益率 (%)</label>
                        <input type="number" id="profitRate2" value="20" step="1">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculatePriceFromCostProfitRate()">計算する</button>
                <div id="result2" class="result-section hidden">
                    <h3>計算結果</h3>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>販売価格（ドル）</label>
                            <div class="value" id="sellingPrice2">-</div>
                        </div>
                        <div class="result-item">
                            <label>想定関税</label>
                            <div class="value" id="tariff2">-</div>
                        </div>
                        <div class="result-item">
                            <label>調整額</label>
                            <div class="value" id="adjustment2">-</div>
                        </div>
                        <div class="result-item">
                            <label>実質販売額</label>
                            <div class="value" id="actualPrice2">-</div>
                        </div>
                        <div class="result-item">
                            <label>送料として徴収関税</label>
                            <div class="value" id="shippingTariff2">-</div>
                        </div>
                        <div class="result-item highlight">
                            <label>DDP価格（ドル）</label>
                            <div class="value" id="ddpPrice2">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfit2">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        販売価格 = (仕入れ価格 + 送料) ÷ 為替レート ÷ (1 - 利益率 - 手数料率 - 広告費率 - ペイオニア率)
                    </div>
                </div>
            </div>

            <!-- セクション: 仕入れ価格算出 -->
            <div class="section-divider">
                <div class="section-title cost-section">仕入れ価格算出</div>
            </div>

            <!-- 利益額ベース: 販売価格→仕入れ -->
            <div class="calculator-card cost-calculation">
                <h2>利益額で計算（販売価格→仕入れ）</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>利益額（円）</label>
                        <input type="number" id="profit3" value="3000" step="100">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateCostFromPriceProfit()">計算する</button>

                <!-- DDU価格からの計算 -->
                <div id="result3-ddu" class="result-section hidden">
                    <h3>DDU価格（関税抜き）から算出</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDU販売価格（ドル）</label>
                            <input type="number" id="sellingPriceDDU3" value="500" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>仕入れ価格（円）</label>
                            <div class="value" id="costPriceDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>想定関税</label>
                            <div class="value" id="tariffDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>調整額</label>
                            <div class="value" id="adjustmentDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>送料として徴収関税</label>
                            <div class="value" id="shippingTariffDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfitDDU3">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        仕入れ価格 = (DDU販売価格 × 為替レート × (1 - 手数料率 - 広告費率 - ペイオニア率)) - 送料 - 利益額
                    </div>
                </div>

                <!-- DDP価格からの計算 -->
                <div id="result3-ddp" class="result-section hidden" style="margin-top: 20px;">
                    <h3>DDP価格（関税込み）から算出</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDP販売価格（ドル）</label>
                            <input type="number" id="sellingPriceDDP3" value="610" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>仕入れ価格（円）</label>
                            <div class="value" id="costPriceDDP3">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfitDDP3">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        仕入れ価格 = ((DDP販売価格 × 為替レート × (1 - 手数料率 - 広告費率 - ペイオニア率)) - 利益額 - 送料 - 通関手数料) ÷ (1 + 関税率 × 安全係数)
                    </div>
                </div>
            </div>

            <!-- 利益率ベース: 販売価格→仕入れ -->
            <div class="calculator-card cost-calculation">
                <h2>利益率で計算（販売価格→仕入れ）</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>利益率 (%)</label>
                        <input type="number" id="profitRate4" value="20" step="1">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateCostFromPriceProfitRate()">計算する</button>

                <!-- DDU価格からの計算 -->
                <div id="result4-ddu" class="result-section hidden">
                    <h3>DDU価格（関税抜き）から算出</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDU販売価格（ドル）</label>
                            <input type="number" id="sellingPriceDDU4" value="500" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>仕入れ価格（円）</label>
                            <div class="value" id="costPriceDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>想定関税</label>
                            <div class="value" id="tariffDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>調整額</label>
                            <div class="value" id="adjustmentDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>送料として徴収関税</label>
                            <div class="value" id="shippingTariffDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfitDDU4">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        仕入れ価格 = (DDU販売価格 × 為替レート × (1 - 利益率 - 手数料率 - 広告費率 - ペイオニア率)) - 送料
                    </div>
                </div>

                <!-- DDP価格からの計算 -->
                <div id="result4-ddp" class="result-section hidden" style="margin-top: 20px;">
                    <h3>DDP価格（関税込み）から算出</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDP販売価格（ドル）</label>
                            <input type="number" id="sellingPriceDDP4" value="610" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>仕入れ価格（円）</label>
                            <div class="value" id="costPriceDDP4">-</div>
                        </div>
                        <div class="result-item">
                            <label>参考利益</label>
                            <div class="value" id="refProfitDDP4">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>計算式:</strong><br>
                        仕入れ価格 = ((DDP販売価格 × 為替レート × (1 - 利益率 - 手数料率 - 広告費率 - ペイオニア率)) - 送料 - 通関手数料) ÷ (1 + 関税率 × 安全係数)
                    </div>
                </div>
            </div>

            <!-- 関税テーブル -->
            <div class="calculator-card tariff-table-section">
                <h2>送料としての関税テーブル</h2>
                <table class="tariff-table">
                    <thead>
                        <tr>
                            <th>販売価格範囲（ドル）</th>
                            <th>送料としての関税（ドル）</th>
                        </tr>
                    </thead>
                    <tbody id="tariffTableBody">
                        <!-- JavaScriptで生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- チュートリアルモーダル -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <h2>使い方ガイド</h2>

            <h3>概要</h3>
            <p>このツールは、EC（電子商取引）における仕入れ価格と販売価格を簡単に計算するためのものです。関税、手数料、送料などを考慮した正確な価格設定が可能です。</p>

            <h3>共通設定について</h3>
            <div class="step">
                <strong>為替レート:</strong> USD/JPYの為替レート。「最新取得」ボタンで自動取得可能です。<br>
                <strong>手数料率:</strong> プラットフォーム手数料の割合（%）<br>
                <strong>広告費率:</strong> 売上に対する広告費の割合（%）<br>
                <strong>ペイオニア手数料:</strong> 決済手数料の割合（%）<br>
                <strong>送料:</strong> 商品の送料（円）<br>
                <strong>関税率:</strong> 関税の割合（%）<br>
                <strong>通関手数料:</strong> 通関にかかる手数料（円）<br>
                <strong>安全係数:</strong> 関税計算時の安全マージン係数<br>
                <strong>DDU閾値:</strong> DDU（関税抜き）価格の閾値（ドル）<br>
                <strong>DDU閾値時の関税額:</strong> 閾値を超えた場合の関税額（ドル）
            </div>

            <h3>カテゴリー別DDU閾値設定</h3>
            <p>商品カテゴリーによってDDU閾値と送料として徴収する関税額が異なります。以下を参考に設定してください。</p>
            <div class="step">
                <strong>Game Software（ゲームソフト）:</strong> DDU閾値 $50、関税額 $20<br>
                <strong>Books（本）:</strong> DDU閾値 $50、関税額 $20<br>
                <strong>Movies & TV:</strong> DDU閾値 $50、関税額 $20<br>
                <strong>Music:</strong> DDU閾値 $75、関税額 $25<br>
                <strong>Game Consoles（ゲーム機）:</strong> DDU閾値 $200、関税額 $50
            </div>

            <h3>4つの計算モード</h3>

            <div class="step">
                <strong>1. 利益額で計算（仕入れ→販売価格）</strong><br>
                仕入れ価格と希望する利益額（円）から、必要な販売価格（ドル）を計算します。<br>
                使用例: 仕入れが5,000円で3,000円の利益が欲しい場合の販売価格は？
            </div>

            <div class="step">
                <strong>2. 利益率で計算（仕入れ→販売価格）</strong><br>
                仕入れ価格と希望する利益率（%）から、必要な販売価格（ドル）を計算します。<br>
                使用例: 仕入れが5,000円で20%の利益率を確保したい場合の販売価格は？
            </div>

            <div class="step">
                <strong>3. 利益額で計算（販売価格→仕入れ）</strong><br>
                販売価格（ドル）と希望する利益額（円）から、適切な仕入れ価格（円）を逆算します。<br>
                DDU価格（関税抜き）とDDP価格（関税込み）の両方から計算できます。<br>
                使用例: 500ドルで販売し、3,000円の利益を得るには、いくらまで仕入れられる？
            </div>

            <div class="step">
                <strong>4. 利益率で計算（販売価格→仕入れ）</strong><br>
                販売価格（ドル）と希望する利益率（%）から、適切な仕入れ価格（円）を逆算します。<br>
                DDU価格（関税抜き）とDDP価格（関税込み）の両方から計算できます。<br>
                使用例: 500ドルで販売し、20%の利益率を確保するには、いくらまで仕入れられる？
            </div>

            <h3>DDU vs DDP について</h3>
            <div class="step">
                <strong>DDU（Delivered Duty Unpaid）:</strong> 関税抜きの価格。購入者が関税を負担します。<br>
                <strong>DDP（Delivered Duty Paid）:</strong> 関税込みの価格。販売者が関税を負担し、価格に含めます。<br>
                <br>
                仕入れ価格算出では、DDU価格とDDP価格の両方を同時に入力・計算できるので、どちらの販売方法でも対応可能です。
            </div>

            <h3>計算式の見方</h3>
            <p>各計算結果の下部には、青い背景の計算式が表示されます。これは実際の数値ではなく、変数名で示されているため、計算ロジックを理解する際に参考にしてください。</p>

            <h3>設定の保存</h3>
            <p>「設定を保存」ボタンをクリックすると、共通設定がブラウザに保存され、次回アクセス時も同じ設定が使用されます。</p>

            <button class="close-btn" onclick="closeTutorial()">閉じる</button>
        </div>
    </div>

    <script>
        // 関税テーブルデータ
        const tariffTable = [
            { min: 0, max: 50, tariff: 20 },
            { min: 51, max: 75, tariff: 25 },
            { min: 76, max: 100, tariff: 30 },
            { min: 101, max: 125, tariff: 35 },
            { min: 126, max: 150, tariff: 40 },
            { min: 151, max: 175, tariff: 45 },
            { min: 176, max: 200, tariff: 50 },
            { min: 201, max: 225, tariff: 55 },
            { min: 226, max: 250, tariff: 60 },
            { min: 251, max: 275, tariff: 65 },
            { min: 276, max: 300, tariff: 70 },
            { min: 301, max: 325, tariff: 75 },
            { min: 326, max: 350, tariff: 80 },
            { min: 351, max: 375, tariff: 85 },
            { min: 376, max: 400, tariff: 90 },
            { min: 401, max: 425, tariff: 95 },
            { min: 426, max: 450, tariff: 100 },
            { min: 451, max: 475, tariff: 105 },
            { min: 476, max: 500, tariff: 110 },
            { min: 501, max: 525, tariff: 115 },
            { min: 526, max: 550, tariff: 120 },
            { min: 551, max: 575, tariff: 125 },
            { min: 576, max: 600, tariff: 130 },
            { min: 601, max: 625, tariff: 135 },
            { min: 626, max: 650, tariff: 140 },
            { min: 651, max: 675, tariff: 145 },
            { min: 676, max: 700, tariff: 150 },
            { min: 701, max: 725, tariff: 155 },
            { min: 726, max: 750, tariff: 160 },
            { min: 751, max: 775, tariff: 165 },
            { min: 776, max: 800, tariff: 170 },
            { min: 801, max: 850, tariff: 180 },
            { min: 851, max: 900, tariff: 190 },
            { min: 901, max: 950, tariff: 200 },
            { min: 951, max: 1000, tariff: 210 },
            { min: 1001, max: 1100, tariff: 230 },
            { min: 1101, max: 1200, tariff: 250 },
            { min: 1201, max: 1300, tariff: 270 },
            { min: 1301, max: 1400, tariff: 290 },
            { min: 1401, max: Infinity, tariff: 310 }
        ];

        // 関税テーブルを表示
        function renderTariffTable() {
            const tbody = document.getElementById('tariffTableBody');
            tariffTable.forEach(row => {
                const tr = document.createElement('tr');
                const maxDisplay = row.max === Infinity ? '以上' : row.max;
                tr.innerHTML = `
                    <td>$${row.min} - $${maxDisplay}</td>
                    <td>$${row.tariff}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 販売価格から関税を取得
        function getTariffFromPrice(price) {
            for (let row of tariffTable) {
                if (price >= row.min && price <= row.max) {
                    return row.tariff;
                }
            }
            return 310; // デフォルト
        }

        // 設定を取得
        function getSettings() {
            return {
                exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
                tariffRate: parseFloat(document.getElementById('tariffRate').value) / 100,
                adRate: parseFloat(document.getElementById('adRate').value) / 100,
                customsFee: parseFloat(document.getElementById('customsFee').value),
                safetyFactor: parseFloat(document.getElementById('safetyFactor').value),
                feeRate: parseFloat(document.getElementById('feeRate').value) / 100,
                payoneerRate: parseFloat(document.getElementById('payoneerRate').value) / 100,
                shippingCost: parseFloat(document.getElementById('shippingCost').value),
                dduThreshold: parseFloat(document.getElementById('dduThreshold').value),
                dduThresholdTariff: parseFloat(document.getElementById('dduThresholdTariff').value)
            };
        }

        // 設定を保存
        function saveSettings() {
            const settings = getSettings();
            localStorage.setItem('ecCalcSettings', JSON.stringify(settings));
            alert('設定を保存しました！');
        }

        // 設定を読み込み
        function loadSettings() {
            const saved = localStorage.getItem('ecCalcSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('exchangeRate').value = settings.exchangeRate;
                document.getElementById('tariffRate').value = settings.tariffRate * 100;
                document.getElementById('adRate').value = settings.adRate * 100;
                document.getElementById('customsFee').value = settings.customsFee;
                document.getElementById('safetyFactor').value = settings.safetyFactor;
                document.getElementById('feeRate').value = settings.feeRate * 100;
                document.getElementById('payoneerRate').value = settings.payoneerRate * 100;
                document.getElementById('shippingCost').value = settings.shippingCost;
                document.getElementById('dduThreshold').value = settings.dduThreshold;
                if (settings.dduThresholdTariff !== undefined) {
                    document.getElementById('dduThresholdTariff').value = settings.dduThresholdTariff;
                }
            }
        }

        // 計算1: 利益額で仕入れ→販売価格
        function calculatePriceFromCostProfit() {
            const settings = getSettings();
            const costJPY = parseFloat(document.getElementById('cost1').value);
            const profitJPY = parseFloat(document.getElementById('profit1').value);

            // 計算ロジック
            // 販売価格 = (仕入れ + 送料 + 利益) / 為替 / (1 - 手数料率 - 広告費率 - ペイオニア率)
            const totalCostJPY = costJPY + settings.shippingCost + profitJPY;
            const netRate = 1 - settings.feeRate - settings.adRate - settings.payoneerRate;
            let sellingPriceUSD = totalCostJPY / settings.exchangeRate / netRate;

            // 想定関税 = 販売価格 * 関税率 + 通関手数料
            let tariffUSD = sellingPriceUSD * settings.tariffRate + settings.customsFee;

            // 調整額 = 想定関税がDDU閾値時の関税額を超えた場合、その差額
            let adjustmentUSD = 0;
            if (tariffUSD >= settings.dduThresholdTariff) {
                adjustmentUSD = tariffUSD - settings.dduThresholdTariff;
            }

            // 実質販売額 = 販売価格 + 調整額
            let actualSellingPriceUSD = adjustmentUSD > 0 ? sellingPriceUSD + adjustmentUSD : sellingPriceUSD;

            // 送料として徴収関税
            const shippingTariff = getTariffFromPrice(sellingPriceUSD);

            // DDP価格 = 実質販売額 + 送料として徴収関税
            const ddpPrice = actualSellingPriceUSD + shippingTariff;

            // 参考利益（再計算）
            const revenue = sellingPriceUSD * settings.exchangeRate;
            const fees = revenue * (settings.feeRate + settings.adRate + settings.payoneerRate);
            const refProfit = revenue - fees - costJPY - settings.shippingCost;

            // 結果表示
            document.getElementById('result1').classList.remove('hidden');
            document.getElementById('sellingPrice1').textContent = `$${sellingPriceUSD.toFixed(2)}`;
            document.getElementById('tariff1').textContent = `$${tariffUSD.toFixed(2)}`;
            document.getElementById('adjustment1').textContent = `$${adjustmentUSD.toFixed(2)}`;
            document.getElementById('actualPrice1').textContent = `$${actualSellingPriceUSD.toFixed(2)}`;
            document.getElementById('shippingTariff1').textContent = `$${shippingTariff}`;
            document.getElementById('ddpPrice1').textContent = `$${ddpPrice.toFixed(2)}`;
            document.getElementById('refProfit1').textContent = `¥${refProfit.toFixed(0)}`;
        }

        // 計算2: 利益率で仕入れ→販売価格
        function calculatePriceFromCostProfitRate() {
            const settings = getSettings();
            const costJPY = parseFloat(document.getElementById('cost2').value);
            const profitRate = parseFloat(document.getElementById('profitRate2').value) / 100;

            // スプレッドシートの式: B16 = (仕入れ + 送料) / (1 - (利益率 + 広告費率 + 手数料率 + ペイオニア率)) / 為替
            const baseCost = costJPY + settings.shippingCost;
            const netRate = 1 - profitRate - settings.feeRate - settings.adRate - settings.payoneerRate;
            let sellingPriceUSD = baseCost / settings.exchangeRate / netRate;

            let tariffUSD = sellingPriceUSD * settings.tariffRate + settings.customsFee;

            let adjustmentUSD = 0;
            if (tariffUSD >= settings.dduThresholdTariff) {
                adjustmentUSD = tariffUSD - settings.dduThresholdTariff;
            }

            let actualSellingPriceUSD = adjustmentUSD > 0 ? sellingPriceUSD + adjustmentUSD : sellingPriceUSD;
            const shippingTariff = getTariffFromPrice(sellingPriceUSD);
            const ddpPrice = actualSellingPriceUSD + shippingTariff;

            const revenue = sellingPriceUSD * settings.exchangeRate;
            const fees = revenue * (settings.feeRate + settings.adRate + settings.payoneerRate);
            const refProfit = revenue - fees - costJPY - settings.shippingCost;

            document.getElementById('result2').classList.remove('hidden');
            document.getElementById('sellingPrice2').textContent = `$${sellingPriceUSD.toFixed(2)}`;
            document.getElementById('tariff2').textContent = `$${tariffUSD.toFixed(2)}`;
            document.getElementById('adjustment2').textContent = `$${adjustmentUSD.toFixed(2)}`;
            document.getElementById('actualPrice2').textContent = `$${actualSellingPriceUSD.toFixed(2)}`;
            document.getElementById('shippingTariff2').textContent = `$${shippingTariff}`;
            document.getElementById('ddpPrice2').textContent = `$${ddpPrice.toFixed(2)}`;
            document.getElementById('refProfit2').textContent = `¥${refProfit.toFixed(0)}`;
        }

        // 計算3: 利益額で販売価格→仕入れ
        function calculateCostFromPriceProfit() {
            const settings = getSettings();
            const profitJPY = parseFloat(document.getElementById('profit3').value);
            const netRate = 1 - settings.feeRate - settings.adRate - settings.payoneerRate;

            // DDU価格からの計算
            const sellingPriceDDU = parseFloat(document.getElementById('sellingPriceDDU3').value);
            const revenueDDU = sellingPriceDDU * settings.exchangeRate;
            const netRevenueDDU = revenueDDU * netRate;
            const costDDU = netRevenueDDU - settings.shippingCost - profitJPY;

            const tariffDDU = sellingPriceDDU * settings.tariffRate + settings.customsFee;
            let adjustmentDDU = 0;
            if (tariffDDU >= settings.dduThresholdTariff) {
                adjustmentDDU = tariffDDU - settings.dduThresholdTariff;
            }

            const shippingTariffDDU = getTariffFromPrice(sellingPriceDDU);
            const feesDDU = revenueDDU * (settings.feeRate + settings.adRate + settings.payoneerRate);
            const refProfitDDU = revenueDDU - feesDDU - costDDU - settings.shippingCost;

            // DDP価格からの計算
            // DDP価格には関税が含まれているため、まず販売価格（DDU）を逆算
            const sellingPriceDDP = parseFloat(document.getElementById('sellingPriceDDP3').value);
            const revenueDDP = sellingPriceDDP * settings.exchangeRate;
            const netRevenueDDP = revenueDDP * netRate;

            // 仕入れ価格 = (DDP価格 × 為替 × netRate - 利益 - 送料 - 通関手数料) / (1 + 関税率 × 安全係数)
            const costDDP = (netRevenueDDP - profitJPY - settings.shippingCost - settings.customsFee) / (1 + settings.tariffRate * settings.safetyFactor);

            // 参考利益 = 設定した利益額（profitJPY）そのもの
            const refProfitDDP = profitJPY;

            // DDU結果表示
            document.getElementById('result3-ddu').classList.remove('hidden');
            document.getElementById('costPriceDDU3').textContent = `¥${costDDU.toFixed(0)}`;
            document.getElementById('tariffDDU3').textContent = `$${tariffDDU.toFixed(2)}`;
            document.getElementById('adjustmentDDU3').textContent = `$${adjustmentDDU.toFixed(2)}`;
            document.getElementById('shippingTariffDDU3').textContent = `$${shippingTariffDDU}`;
            document.getElementById('refProfitDDU3').textContent = `¥${refProfitDDU.toFixed(0)}`;

            // DDP結果表示
            document.getElementById('result3-ddp').classList.remove('hidden');
            document.getElementById('costPriceDDP3').textContent = `¥${costDDP.toFixed(0)}`;
            document.getElementById('refProfitDDP3').textContent = `¥${refProfitDDP.toFixed(0)}`;
        }

        // 計算4: 利益率で販売価格→仕入れ
        function calculateCostFromPriceProfitRate() {
            const settings = getSettings();
            const profitRate = parseFloat(document.getElementById('profitRate4').value) / 100;
            const netRate = 1 - profitRate - settings.feeRate - settings.adRate - settings.payoneerRate;

            // DDU価格からの計算
            const sellingPriceDDU = parseFloat(document.getElementById('sellingPriceDDU4').value);
            const revenueDDU = sellingPriceDDU * settings.exchangeRate;
            const costDDU = revenueDDU * netRate - settings.shippingCost;

            const tariffDDU = sellingPriceDDU * settings.tariffRate + settings.customsFee;
            let adjustmentDDU = 0;
            if (tariffDDU >= settings.dduThresholdTariff) {
                adjustmentDDU = tariffDDU - settings.dduThresholdTariff;
            }

            const shippingTariffDDU = getTariffFromPrice(sellingPriceDDU);
            const feesDDU = revenueDDU * (settings.feeRate + settings.adRate + settings.payoneerRate);
            const refProfitDDU = revenueDDU - feesDDU - costDDU - settings.shippingCost;

            // DDP価格からの計算
            const sellingPriceDDP = parseFloat(document.getElementById('sellingPriceDDP4').value);
            const revenueDDP = sellingPriceDDP * settings.exchangeRate;
            const netRevenueDDP = revenueDDP * netRate;
            const costDDP = (netRevenueDDP - settings.shippingCost - settings.customsFee) / (1 + settings.tariffRate * settings.safetyFactor);

            // 参考利益 = 収入 × 利益率（手数料引く前の収入に対する利益率）
            const feesDDP = revenueDDP * (settings.feeRate + settings.adRate + settings.payoneerRate);
            const refProfitDDP = revenueDDP - feesDDP - costDDP - settings.shippingCost - (costDDP * settings.tariffRate * settings.safetyFactor + settings.customsFee);

            // DDU結果表示
            document.getElementById('result4-ddu').classList.remove('hidden');
            document.getElementById('costPriceDDU4').textContent = `¥${costDDU.toFixed(0)}`;
            document.getElementById('tariffDDU4').textContent = `$${tariffDDU.toFixed(2)}`;
            document.getElementById('adjustmentDDU4').textContent = `$${adjustmentDDU.toFixed(2)}`;
            document.getElementById('shippingTariffDDU4').textContent = `$${shippingTariffDDU}`;
            document.getElementById('refProfitDDU4').textContent = `¥${refProfitDDU.toFixed(0)}`;

            // DDP結果表示
            document.getElementById('result4-ddp').classList.remove('hidden');
            document.getElementById('costPriceDDP4').textContent = `¥${costDDP.toFixed(0)}`;
            document.getElementById('refProfitDDP4').textContent = `¥${refProfitDDP.toFixed(0)}`;
        }

        // 為替レートを自動取得
        async function fetchExchangeRate() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = '取得中...';

            try {
                // 無料のAPI（exchangerate-api.com）を使用
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();

                if (data && data.rates && data.rates.JPY) {
                    const rate = data.rates.JPY;
                    document.getElementById('exchangeRate').value = rate.toFixed(3);
                    alert(`最新の為替レートを取得しました: $1 = ¥${rate.toFixed(3)}`);
                } else {
                    throw new Error('為替レートの取得に失敗しました');
                }
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                alert('為替レートの取得に失敗しました。手動で入力してください。');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = '最新取得';
            }
        }

        // チュートリアルを開く
        function openTutorial() {
            document.getElementById('tutorialModal').classList.add('show');
        }

        // チュートリアルを閉じる
        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('show');
        }

        // モーダルの外側をクリックしたら閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('tutorialModal');
            if (event.target === modal) {
                closeTutorial();
            }
        };

        // 初期化
        window.onload = function() {
            loadSettings();
            renderTariffTable();
            // ページ読み込み時に自動で為替レートを取得
            fetchExchangeRate();
        };
    </script>
</body>
</html>
